# DNS-based discovery: all nodes share a network alias that resolves to all container IPs.
# No need to list peers explicitly â€” each node discovers the others via DNS.
#
# Kubernetes equivalent: create a headless Service and set
#   AUTH_MANAGER_DISCOVERY_DNS_NAME to the service FQDN.

x-common-env: &common-env
  AUTH_MANAGER_BIND_ADDRESS: "0.0.0.0:8080"
  AUTH_MANAGER_DATA_DIR: /data
  AUTH_MANAGER_DISCOVERY_DNS_NAME: auth-manager
  LOG_FORMAT: json
  RUST_LOG: auth_manager=debug

x-common: &common
  build:
    context: .
    args:
      CREATED: "${CREATED:-}"
      VERSION: "${VERSION:-0.1.0}"
  networks:
    auth-network:
      aliases:
        - auth-manager
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8080/_internal/health"]
    interval: 5s
    timeout: 3s
    retries: 3
    start_period: 10s

services:
  node-1:
    <<: *common
    container_name: auth-manager-node-1
    environment:
      <<: *common-env
      AUTH_MANAGER_NODE_ID: node-1
    ports:
      - "8081:8080"
    volumes:
      - node1-data:/data

  node-2:
    <<: *common
    container_name: auth-manager-node-2
    environment:
      <<: *common-env
      AUTH_MANAGER_NODE_ID: node-2
    ports:
      - "8082:8080"
    volumes:
      - node2-data:/data

  node-3:
    <<: *common
    container_name: auth-manager-node-3
    environment:
      <<: *common-env
      AUTH_MANAGER_NODE_ID: node-3
    ports:
      - "8083:8080"
    volumes:
      - node3-data:/data

volumes:
  node1-data:
  node2-data:
  node3-data:

networks:
  auth-network:
    driver: bridge
