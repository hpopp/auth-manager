x-common-env: &common-env
  AUTH_MANAGER_BIND_ADDRESS: "0.0.0.0:8080"
  AUTH_MANAGER_DATA_DIR: /data
  AUTH_MANAGER_PEERS: node-1:8080,node-2:8080,node-3:8080
  RUST_LOG: auth_manager=debug

services:
  node-1:
    build: .
    container_name: auth-manager-node-1
    environment:
      <<: *common-env
      AUTH_MANAGER_NODE_ID: node-1
    ports:
      - "8081:8080"
    volumes:
      - node1-data:/data
    networks:
      - auth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  node-2:
    build: .
    container_name: auth-manager-node-2
    environment:
      <<: *common-env
      AUTH_MANAGER_NODE_ID: node-2
    ports:
      - "8082:8080"
    volumes:
      - node2-data:/data
    networks:
      - auth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  node-3:
    build: .
    container_name: auth-manager-node-3
    environment:
      <<: *common-env
      AUTH_MANAGER_NODE_ID: node-3
    ports:
      - "8083:8080"
    volumes:
      - node3-data:/data
    networks:
      - auth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  node1-data:
  node2-data:
  node3-data:

networks:
  auth-network:
    driver: bridge
